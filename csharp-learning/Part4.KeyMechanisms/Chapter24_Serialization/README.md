# Глава 24. Сериализация

Сериализация - процесс преобразования объекта или графа связанных объектов в поток байтов. 
Соответственно, обратное преобразование называется десериализацией.

Несколько примеров применения этого механизма:

1. Состояния приложения (граф объекта) можно легко сохранить в файле на диске или в базе 
данных и восстановить при последующем запуске приложения. ASP.NET сохраняет и восстанавливает
состояния сеанса путем сериализации и десериализации.

2. Набор объектов можно скопировать в буфер обмена и вставить в то же или в другое приложение.
Этот подход используется в приложения Window Forms и Windows Presentation Foundation (WPF)

3. Можно клонировать набор объектов и сохранить как "резервную копию", пока пользователь работает
с "основным" набором объектов

4. Набор объектов можно легко передать по сети в процесс, запущенный на другой машине. Механизм 
удаленного взаимодействия платформы .NET сериализует и десериализует объекты, продвигаемые 
по значению. Эта же технология используется при передаче объектов через границы домена.

После сериализации объектов в поток байтов в памяти появляется возможность дополнительной
обработки данных - например, шифрования или сжатия

Разработчикам приходится решать проблемы взаимодействия протоколов, несовпадения типов данных
клиента и сервера (например, разный порядок следования байтов), обработки ошибок, ссылок одних
объектов на другие, параметров in и out, массивов структур - и этот список можно продолжать 
бесконечно.

Эти сложные проблемы уже решены в .NET. Разработчик может использовать объекты до сериализации
и после десериализации, а всю работу о том, что происходит между этими двумя процедурами на себя
берет .NET.

В этой главе рассказывается, как сервис сериализации реализован в .NET. Эти процедуры 
определены практически для всех типов данных, а следовательно, вам не придется предпринимать 
дополнительных усилий, чтобы сделать свои типы сериализуемыми. Впрочем существуют типы, для которых
подобная предварительная подготовка необходима. К счастью, механизм сериализации .NET поддерживает
расширение, и мы детально рассмотрим данный процесс, позволяющий выполнить различные операции 
при сериализации и десериализации объектов. К примеру, покажется, как сериализовав одну версию
объекта в файл на диске, десериализовать его потом в другую версию.

### ПРИМЕЧАНИЕ

В этой главе в основном рассматриваются технологии сериализации в среде CLR, которая хорошо 
распознает типы данных CLR, и умеет сериализовать поля объектов, помеченных как public, 
protected, internal и даже private, превращая их в сжатый двоичный поток и тем самым повышая
производительность. Для сериализации типов данных CLR в поток XML требуется класс
System.Runtime.Serialization.NetDataContractSerializer. Платформа .NET предлагает и другие
технологии сериализации, для взаимодействия между CLR-совместимыми и CLR-несовместимыми типами
данных. В них используются классы System.Xml.Serialization.XmlSerializer и 
System.Runtime.Serialization.DataContractSerializer

## Практический пример сериализации/десериализации

Это очень просто! Метод SerializeToMemory создает объект System.IO.MemoryStream. Этот объект
определяет, куда следует поместить сериализованный блок байтов. Затем метод конструирует 
объект BinaryFormatter (расположенный в пространстве имен System.Runtime.Serialization.Formatters.Binary).
Модулем форматирования (formatter) называется тип (он реализует интерфейс
System.Runtime.Serialization.IFormatter), умеющий сериализовать и десериализовать граф объектов.
В библиотеку FCL включены два модуля форматирования: BinaryFormatter (используется в 
примере) и SoapFormatter (находяющийся в пространстве System.Runtime.Serialization.Formatters.Soap)
и реализованный в сборке System.Runtime.Serialization.Formatter.Soap.dll)

### ПРИМЕЧАНИЕ

Начиная с версии 3.5, в .NET Framework класс SoapFormatter считается устаревшим
и не рекомендуется к использованию. Однако его имеет смысл применять при отладке
кода сериализации, так как он создает доступный для чтения текст в формате XML. 
Если в выходном коде вы хотите воспользоваться механизмами XML-сериализации
и XML-десериализации, обратитесь к классам XmlSerializer и DataContractSerializer.

Для сериализации графа объектов достаточно вызвать метод Serialize модуля 
форматирования и передать ему, во-первых, ссылку на объект потока ввода-вывода, во-вторых, 
ссылку на сериализуемый граф. Поток ввода-вывода указывает, 
куда следует поместить сериализуемые байты. Его роль может играть объект 
любого типа, производного от абстрактного базового класса System.IO.Stream. 
Это означает, что граф может быть сериализован в тип MemoryStream, FileStream, 
NetworkStream и т. п.
